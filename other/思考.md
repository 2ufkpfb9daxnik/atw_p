# yet another e-typingで八重タイピング、Alternative Typing ContestとTypeWellでatw

- ブラウザでも良いが、windowsなどの普通のソフトウェアとして動く。
- 1分モードと1時間モードは公式でランキングも用意しておく。そうではなくて自分で設定するモードもあるが、これにはランキングは用意しない。
- お題がランダムに流れてくるのでそれを打つ。お題とお題の間はスペースを打つ(これは変換操作のつもり/タイプウェルでもお題(タイプウェルのお題は単語単位だったが)の間ではスペースを打っていた)。
- スコアは変換後の文字数。ひらがな数や打鍵数ではない。これなら漢直/かな入力/ローマ字入力で公平(本来的にはかな入力の方が有利になってしまうかもしれないが、ゲームではなくてあくまでタイピング練習ソフトなので、最終的に世の中に出力される文字数がどれだけ多いかが重要)。ミスは、漢直では考慮しない。ローマ字入力/かな入力では、最終スコアからミス打鍵数をそのまま引く(このスコアに対してA, B, C, ...などのランクを与えたいが、この名前の付け方については議論する必要がある。タイプウェルでは低い方からj, i, ...,b, a, s, sj, si, ..., sb, sa, ss, xj, xi, ..., xb, xa, xs, xx, zj, zi, ..., zb, za, zs, zx, zz, m1, m2, m3, m4, m5まで用意されていた。人類の到達地点としてはおよそzg当たりまで。このような細かいのもよいが、これをまるまるパクってしまうというのもなあ。個人的にはなぜjで止めたのかに納得行く説明がないので、何か適当なところで決めてしまいたいが、普通にスコアの数字だけでもいいのかも。)。
- お題は1つの文章。長くてもまあ200文字程度くらいには収める。
- たくさんお題を収録する。話題には、とりあえずJIS第1水準の漢字についてお題を1つ作る。これでおよそ3000個。これは硬い目の文章になる予定なので、もう少しラフなSNSなどの投稿なども加える(その時のはやりの言葉やコンテンツなどについてはできるだけ星新一的な一般を行い、あとの時代から見ても普遍的に通用するようにする)。これもおよそ3000個。合計6000程度あるとまあ十分かもしれないが、タイプウェルでは基本常用語・カタカナ語・漢字・慣用句ことわざ合わせて約1万のお題があるためこれに合わせてもよいかも。でもカタカナ語は今の日本語でもあんまり聞かなかったりするし微妙？漢字は日本の地名がたくさん収録されていて、これは使っても良いかもしれないが難読なのであんまり乗り気ではない。そう考えると結構上記の6000個はちょうどいい感じではないかと思う。
- 目標スコアを表示表示する。表示するかしないかのON/OFFボタンをつける。
- キーガイドを常に表示する。次に打つキー、その次に打つキー、くらいまでは表示する。キーにはその配列での文字を表示する。
- 様々な入力方法に対応する。これは具体的には順次打鍵の配列はだいたいmozcの方法で記述可能なので、これは全部対応する。漢直モード(単純に一致しているかを見るだけ)も入れる(mozcの方法で漢直も実装可能であるが、実際漢直を使うときは、全部を覚えているのではなくて交ぜ書き変換や部首合成などの処理を行うことが多く、これは対応しきれない。そのため参考記録とする)。同時打鍵は、今のところ私が興味ないのでやらない。
- 経過タイム表示/経過ラップタイム表示/ミス数表示。ON/OFFボタンをつける。
- 普通の文章列を左上から右下へと改行しながら打っていく方式と、流れる文字方式が両立する。普通は文字が進むと右へ右へと移動して表示されるが、これは一度打った文字はもう打たなくていいというタイピングゲームの性質を利用して、文字がどんどん左へ進み、目を常に同じ位置に入れておけばよいというもの。どちらか片方は必ずONで、もう2つともONでもよい。
- 漢字仮名交じり文、ひらがな、入力打鍵列(アルファベットで表記されている)をすべて上からこの順番に表示する。特に入力打鍵列については、複数の入力方法が許容されている場合は、表示されているものと違う入力をされたら即座にその別の入力方法に表示が変化する。流れる文字方式では、横方向の位置はズレてしまうが、打鍵中に常に同じ軸になるようにしたい。
- タイプウェルでは非常に詳細な結果分析・記録が特徴であったので、いくつかを取り入れたい。
  - 10秒毎のラップ・ペース。そのラップでは全体と比べて早かったか、遅かったか？どのラップが最も早かったか?
  - お題(単語単位)の加速・減速。これは単語単位だからできた技で、長めの文章だと難しいだろう。しかし、5文字くらいの単位で加速/減速などは取りたい。文字(ひらがな)単位でも存在するがこれは可能(漢直は難しいか)。
  - 時刻ごとのスコアグラフ。この時刻の打鍵ペースではスコアZHだったが後半ではXHまで落ちた、などがグラフで表示される。これはわかりやすくてよい。
  - 最低速のときでずっとうち続けたときのスコアと最高速のときでずっとうち続けたときのスコアの表示。そしてその中間であったのであなたは今回のようなスコアであったという表示。
  - リプレイ機能
  - 上位15のランキング。スコア、ラップごとのペース、ミス、打った年月日時分秒まで記録されている。これは現代ではすべての練習記録をとっても良いと思う。スコア順、時系列順にソートするのも必須だろう。
  - 日別・月別起動履歴。ここまで来るとかなりアスリート的ではないかと思うが、まああってもいいだろう。
  - 苦手なお題を集中的に練習するモード。そして苦手なお題に入れるかどうかのしきい値を自由に設定する。

## アルゴリズムの大まかな流れ

1. ルールテーブル（「入力ローマ字列 → 出力かな／次処理」）をロード。
2. ユーザがキーを打鍵するたびに「バッファ（保留入力列）」に追加。
3. バッファ＋新打鍵キーをもとに プレフィックス検索 を行い、ルールテーブルの中で「このバッファ列にマッチする入力列」があるかを探す。
4. 見つかったマッチ候補のうち 最長一致（Longest Match） を優先。
5. マッチしたルールの「出力かな部分／次処理（確定 or 保留）／バッファのクリア／削除」などの指示を実行。
6. 保留（次に続く可能性あり）ならバッファをそのまま残し、次のキー待ち。確定ならバッファをクリア（あるいは残りをルールによって扱う）して、次の打鍵を新たなバッファとして始動。
7. 特殊なルール（撥音 ‘n’ / 促音 ‘っ’ /長音／拗音）や打鍵揺れ（si/shi, fu/hu 等）はテーブルに明記されたマッチルールで優先的に扱い、上記流れに組み込まれている。
8. 出力かなが決まると、それをタイピングゲーム側では「正しい入力が完了した」として扱う。誤入力または期待外のキー列であったらバッファクリア／誤入力扱い。

## 状態遷移モデル

- 状態 S0（初期／バッファ空）
  - 新たなキー入力を受けてバッファ = 入力キー。次へ→状態 S1。
- 状態 S1（バッファあり）
  - 入力キーを受けてバッファ拡張 → buffer + new_key
  - ルールテーブルに「バッファ列」を入力キーとして持つマッチがあるかを調べる。
  - マッチあり（かつもっと長いマッチもありうる） → 状態 S2（保留中）
  - マッチあり（これが最長で次に続くキーでマッチ拡張されない） → 確定処理 → バッファクリア→状態 S0
  - マッチなし → 誤入力扱い or バッファを先頭切って再試行 →状態 S0
- 状態 S2（保留中：バッファが将来マッチ拡張可能）
  - 新キーを入力 →バッファ拡張 → 再度同じチェック。
  - また、「バッファ列自身が確定ルールとしても使える場合」もあり、この場合は確定＋残余バッファの処理が必要（例：入力 “k” は単独 “く” にもマッチ、さらに “ky” で “きゃ” にもなる等）
  - ユーザが “決定キー（Enter／Space）” を押す操作をゲーム的に “確定”として扱うなら、この状態で強制確定させるオプションも設ける。
- その他状態（必要なら）
  - AFTER_N：バッファが “n” だけの状態で、次が母音／yか子音かを判定待ち
  - AFTER_CONSONANT_DOUBLE：促音候補（同子音連続）待ち
